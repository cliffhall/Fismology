<html>
<head>
    <!-- Styles -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.0/dist/jquery.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fismo/sdk/browser/index.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/web3/dist/web3.min.js"></script>

    <!-- Metamask Onboarding -->
    <script src="https://cdn.jsdelivr.net/npm/@metamask/onboarding/dist/metamask-onboarding.bundle.js"></script>

    <!-- Local Styles -->
    <link href="style/styles.css" rel="stylesheet">

    <!-- PAGE TITLE -->
    <title>Lockable Door - Fismology</title>

</head>
<body class="pageBg">

    <!-- UI Wiring -->
    <script>

        // ---- ---- ---- ---- ---- VARIABLES ---- ---- ---- ---- ----

        let fismoABI, fismoView, operator, currentState, transitions, transition, opt, actionId;
        let desiredChain = "80001"; // Polygon Mumbai Testnet
        let confirmationThreshold = 3; // How many confirmations before assuming success
        let onboarding, wallet, accounts, connected = false;
        let connectButton, goButton, walletField, stateField, inputForm, actionSelect;
        let lockedImg, openedImg, closedImg, sendingImg, waitingImg;
        let txHash, confirmations = 0;
        let machineId = Fismo.nameToId("LockableDoor");

       // URL of the Polygon Mumbai block explorer
        const explorer = "https://mumbai.polygonscan.com/address/";

        // Clone of the official Fismo contract on Polygon Mumbai
        // NOTE: Actions on this contract must be initiated by the Operator contract specified by the installed Machine
        const fismoAddress = "0x3d3618dD34c77c56D09F57F2Cb98eE0AA0719B4b";

        // Deployed instance of LockableDoorGuards contract
        // NOTE: Transactions don't go to this contract. Fismo uses it as a logic implementation for transition guards
        const guardAddress = "0x3f0D8faCb355001e15614d185DFf18ACC43a20ea";

        // Clone of the official Operator contract on Polygon Mumbai
        // NOTE: This is the contract specified by the installed Machine, that we use to invoke actions
        const operatorAddress = "0x9fd2610521AF0126D212b40F90720C6f80285A4b";

        // ---- ---- ---- ---- ---- FETCH CURRENT STATE  ---- ---- ---- ---- ----

        const fetchCurrentState = async () => {

            // Get user's current state from the fismo contract and marshal response into entity
            const response = await fismoView.methods.getUserState(accounts[0], machineId).call();
            currentState = Fismo.State.fromStruct(response);

            // Manage display of current State
            stateField.value = currentState.name;
            switch (currentState.name) {
                case "Closed":
                    lockedImg.classList.add("hide");
                    openedImg.classList.add("hide");
                    closedImg.classList.remove("hide");
                    break;

                case "Locked":
                    lockedImg.classList.remove("hide");
                    openedImg.classList.add("hide");
                    closedImg.classList.add("hide");
                    break;

                case "Opened":
                    lockedImg.classList.add("hide");
                    openedImg.classList.remove("hide");
                    closedImg.classList.add("hide");
                    break;
            }

            // Get the action select and remove current options
            for (let i = actionSelect.options.length - 1; i > 0; i--) {
                actionSelect.remove(i);
            }

            // Get the valid transitions from this state
            transitions = currentState.transitions;

            // Add the actions to the select
            transitions.forEach(transition => {
                opt = document.createElement('option');
                opt.value = Fismo.nameToId(transition.action);
                opt.innerHTML = transition.action;
                actionSelect.appendChild(opt);
            });

            // Enable action selection
            actionSelect.disabled = false;
        }

        // ---- ---- ---- ---- ------  ACTION CHOSEN  ------ ---- ---- ---- -----

        const invokeAction = async () => {

            actionSelect.disabled = true;
            goButton.classList.add("hide");
            sendingImg.classList.remove("hide");

            // Invoke the action
            operator.methods
                .invokeAction(machineId, actionId)
                .send({from: wallet})
                .on('transactionHash', function(hash){
                    txHash = hash; // TODO: prepare view transaction link
                    confirmations = 0;
                })
                .on('confirmation', async function(confirmationNumber, receipt){
                    if (confirmationNumber === 1) {
                        sendingImg.classList.add("hide");
                        waitingImg.classList.remove("hide");
                    }
                    if (++confirmations > confirmationThreshold) {
                        confirmations = 0;
                        waitingImg.classList.add("hide");
                        await fetchCurrentState();
                    }
                })
                .on('error', function(error, receipt) {
                    waitingImg.classList.add("hide");

                    console.log("transaction error:", error);
                });
        }

        const actionChosen = (selectedActionId) => {
            actionId = selectedActionId;

            // Manage Go button
            if (actionId === "") {
                goButton.classList.add('hide');
                goButton.disabled = true;
                goButton.onclick = null;
                actionSelect.disabled = false;
            } else {
                goButton.classList.remove('hide');
                goButton.disabled = false;
                goButton.onclick = invokeAction;
            }

        }

        // ---- ---- ---- ---- ----  NETWORK CONNECTION  ---- ---- ---- ---- ----

        const isCorrectNetwork = () => window.ethereum.networkVersion === desiredChain;

        const setNeedsOnboarding = () => {
            connectButton.innerText = 'Install MetaMask';
            connectButton.disabled = false;
            connectButton.onclick = () => {
                onboarding.startOnboarding();
                setOnboarding();
            };
        }

        const setOnboarding = () => {
            connectButton.innerText = 'Onboarding in progress';
            connectButton.disabled = true;
        }

        const setDisconnected = async () => {
            inputForm.classList.add('hide');
            connectButton.innerText = 'Connect Wallet';
            connectButton.disabled = false;
            connectButton.onclick = async () => {

                // Is metamask available?
                if (window.ethereum) {

                    // Create web3 instance for transactions
                    window.web3 = new Web3(window.ethereum);

                    // Get operator contract
                    operator = await new window.web3.eth.Contract(fismoABI.Operator, operatorAddress);

                    // Get fismo contract, cast to IFismoView (for reading only)
                    fismoView = await new window.web3.eth.Contract(fismoABI.IFismoView, fismoAddress);

                    // Update UI when network changes
                    window.ethereum.on('chainChanged', refreshNetworkStatus);
                    window.ethereum.on('networkChanged', refreshNetworkStatus);

                    // Get the accounts
                    accounts = await window.ethereum.enable();
                    if (accounts && accounts.length) {
                        setConnected(accounts[0]);
                    }

                    await fetchCurrentState(wallet);
                }
            }
        }

        const setConnected = (account) => {
            wallet = account;
            connected = true;
            onboarding.stopOnboarding();
            walletField.value = account;
            connectButton.onclick = null;
            connectButton.disabled = true;
            if (isCorrectNetwork()) {
                connectButton.innerText = 'Wallet Connected';
                inputForm.classList.remove('hide');
            } else {
                connectButton.innerText = 'Wrong Network';
                inputForm.classList.add('hide');
            }

        }

        const refreshNetworkStatus = async () => {

            if (!MetaMaskOnboarding.isMetaMaskInstalled()) {

                setNeedsOnboarding();

            } else if (accounts && accounts.length > 0) {

                setConnected(accounts[0]);

            } else {

                setDisconnected();

            }

        };

        // ---- ---- ---- ---- ---- DOM CONTENT LOADED  ---- ---- ---- ---- ----

        // Prepare environment once loaded
        window.addEventListener('DOMContentLoaded', async () => {

            // Prepare MetaMask onboarding
            onboarding = new MetaMaskOnboarding();

            // Get handles to DOM elements
            connectButton = document.getElementById('connect');
            actionSelect = document.getElementById('actions');
            inputForm  = document.getElementById('inputForm');
            walletField = document.getElementById('wallet');
            stateField = document.getElementById('state');
            goButton = document.getElementById('go');

            // Set Explorer links
            document.getElementById('fismoLink').href = `${explorer}${fismoAddress}#code`;
            document.getElementById('operatorLink').href = `${explorer}${operatorAddress}#code`;
            document.getElementById('guardLink').href = `${explorer}${guardAddress}#code`;

            // Add action select listener
            actionSelect.addEventListener('change', (event) => {
                actionChosen(event.target.value);
            });

            // Get the Fismo ABI from the SDK
            fetch("https://cdn.jsdelivr.net/npm/fismo/sdk/fismo-abi.json")
                .then(response => {
                    return response.text();
                })
                .then(async text => {
                    // Parse the ABI into an object
                    fismoABI = JSON.parse(text);

                    // Update the UI with the network status
                    await refreshNetworkStatus();
                });
        });

    </script>

    <!-- ---- ---- ---- ---- ---- HEADER & NAVIGATION ---- ---- ---- ---- ---- -->
    <div class="container">
        <header class="d-flex flex-wrap justify-content-center py-3 mb-4">
            <a href="https://github.com/cliffhall/Fismology"
               class="d-flex align-items-center mb-3 mb-md-0 me-lg-auto">
                <span class="fs-4"><img src="images/Fismology.png" height="50"></span>
            </a>

            <ul class="nav nav-pills">
                <li class="nav-item"><a href="#diagram" class="nav-link link">Diagram</a></li>
                <li class="nav-item"><a href="#need-a-wallet" class="nav-link link">Need a Wallet?</a></li>
                <li class="nav-item">
                    <button id="connect" type="button" disabled class="btn darkBg">Loading...</button>
                </li>
            </ul>
        </header>
    </div>

    <!-- ---- ---- ---- ---- ---- ---- CONTENT ---- ---- ---- ---- ---- ---- -->
    <div class="container col-xxl-8 px-4 py-5">

        <!-- Form and Machine -->
        <div class="row flex-lg-row-reverse align-items-top g-5 py-5">

            <!-- Form -->
            <div class="col-lg-6">

                <!-- Form Header -->
                <h1 class="display-5 fw-bold lh-1 mb-3">Lockable Door Machine</h1>
                <b>Interact with a Fismo Machine installed on a public blockchain.</b>
                <div class="col-lg">
                    <ul >
                    <li>Connect your wallet to the <b>Polygon Mumbai Testnet</b> network.</li>
                    <li>Your current state in the machine will be shown.</li>
                    <li>Choose an action and click <b>Let's Go!</b></li>
                    <li>View the cloned
                        <a id="fismoLink" href="" target="_blank" rel="noopener noreferrer nofollow" class="link">Fismo</a>
                        and
                        <a id="operatorLink" href="" target="_blank" rel="noopener noreferrer nofollow" class="link">Operator</a> contracts.
                    </li>
                    <li>View the deployed <a id="guardLink" href="" target="_blank" rel="noopener noreferrer nofollow" class="link">LockableDoorGuards</a> logic contract.</li>
                    </ul>
                </div>

                <!-- Form Fields -->
                <div id="inputForm" class="d-grid gap-2 d-md-flex justify-content-md-start hide">
                    <div class="col-lg">

                        <!-- Wallet Field-->
                        <div class="input-group mb-3">
                            <div class="input-group-text lightBg">Wallet&nbsp;</div>
                            <input type="text" id="wallet" name="wallet" disabled class="form-control address"/>
                        </div>

                        <!-- State Field-->
                        <div class="input-group mb-3">
                            <div class="input-group-text lightBg">State&nbsp;&nbsp;</div>
                            <input type="text" id="state" name="state" disabled class="form-control"/>
                        </div>

                        <!-- Action Select -->
                        <div class="input-group mb-3">
                            <div class="input-group-text darkBg">Action</div>
                            <select id="actions" class="form-select">
                                <option value="">Choose an Action</option>
                            </select>
                        </div>

                        <!-- Go Button / Spinners -->
                        <div class="d-flex flex-wrap justify-content-end">

                            <!-- Go Button -->
                            <button id="go" disabled class="btn darkBg hide">Let's Go!</button>

                            <!-- Sending Spinner -->
                            <img id="sending" class="hide" src="images/sending.gif"
                                 onload="sendingImg = document.getElementById('sending')"
                                 width="38" height="38"/>

                            <!-- Waiting Spinner -->
                            <img id="waiting" class="hide" src="images/waiting.gif"
                                 onload="waitingImg = document.getElementById('waiting')"
                                 width="38" height="38"/>
                        </div>

                    </div>
                </div>
            </div>

            <!-- Machine / State Display -->
            <div class="col-lg-6">

                <div class="visual">

                    <!-- Machine Background -->
                    <img id="machine" class="machine" src="images/machine.png"/>

                    <!-- Locked Overlay -->
                    <img id="state-locked" class="overlay hide" src="images/LockableDoor/Locked.png"
                         onload="lockedImg = document.getElementById('state-locked');"
                         width="100%"/>

                    <!-- Closed Overlay -->
                    <img id="state-closed"  class="overlay hide" src="images/LockableDoor/Unlocked.png"
                         onload="closedImg = document.getElementById('state-closed');"
                         width="100%"/>

                    <!-- Opened Overlay -->
                    <img id="state-opened" class="overlay hide" src="images/LockableDoor/Opened.png"
                         onload="openedImg = document.getElementById('state-opened');"
                         width="100%"/>
                </div>

            </div>

        </div>

        <!-- State Machine Diagram -->
        <div id="diagram" class="container px-4 py-5">
            <img src="images/LockableDoorFSM.png" width="100%"/>
        </div>

        <!-- Need a Wallet? -->
        <div  id="need-a-wallet" class="container px-4 py-5">

            <h1 class="display-4 fw-bold text-center">Need a Funded Wallet?</h1>

            <div class="row g-4 py-5 row-cols-1 row-cols-lg-2">
                <div class="feature col justify">
                    <h2>1. Install MetaMask</h2>
                    <p>MetaMask is a web extension, which allows you to manage your blockchain assets via your web browser.</p>
                    <p>If you don't have MetaMask installed you will see a button on the form above that says <b>"Install Metamask"</b>. Click it and follow all instructions.</p>
                    <p>Once your MetaMask wallet is installed you will be returned to this page, and the button will have changed to say <b>"Connect Wallet"</b>.</p>
                </div>
                <div class="feature col">
                    <h2>2. Configure</h2>
                    <p>Configure MetaMask for the <b>Polygon Mumbai Testnet</b> network.</p>
                    <p>In order to view the assets in your account on the <b>Polygon Mumbai Testnet</b> network, you may need to configure Maticâ€™s URL on Metamask.</p>
                </div>
                <div class="feature col">
                    <h2>3. Connect</h2>
                    <p>On the form above, click the button that says <b>"Connect Wallet"</b>.</p>
                    <p>MetaMask will open a window to ask if you'd like to connect to this site. Click <b>"Connect"</b>.</p>
                    <p>The <b>"Connect Wallet"</b> button above will be replaced with the phrase <b>"Wallet Connected"</b>.</p>
                    <p>If you see the phrase <b>"Wrong Network"</b>, click the MetaMask icon on your browser and choose the <b>Polygon Mumbai Testnet</b> network from the dropdown at the top.</p>
                </div>
                <div class="feature col">
                    <h2>4. Get $MATIC</h2>
                    <p>You can get free  <b>Polygon Mumbai $MATIC</b> at the
                        <a href="https://faucet.polygon.technology/" target="_blank" rel="noopener noreferrer nofollow" class="link">Polygon Faucet</a>
                    </p>
                </div>
            </div>
        </div>

    </div>

    <!-- ---- ---- ---- ---- ---- FOOTER ---- ---- ---- ---- ---- -->
    <nav class="navbar fixed-bottom navbar-light pageBg">
        <div class="container justify-content-center">
            <a class="navbar-brand" href="https://futurescale.com" target="_blank" rel="noopener noreferrer nofollow">
                <img src="images/created-by.png" height="38">
            </a>
        </div>
    </nav>

</body>
</html>
