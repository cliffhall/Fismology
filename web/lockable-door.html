<html>
<head>
    <!-- Fismo SDK -->
    <script src="../node_modules/fismo/sdk/browser/index.js"></script>

    <!-- Bootstrap CSS
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">
    -->

    <!-- Styles -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.0/dist/jquery.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <!-- Local Styles -->
    <link href="style/styles.css" rel="stylesheet">

    <!-- PAGE TITLE -->
    <title>Lockable Door - Fismology</title>

</head>
<body class="pageBg">

    <!-- Metamask Onboarding -->
    <script src="../node_modules/@metamask/onboarding/dist/metamask-onboarding.bundle.js"></script>

    <!-- UI Wiring -->
    <script>
        let desiredChain = "80001";
        let onboarding, wallet, accounts, connected = false;
        let connectButton, goButton, walletField, stateField;

        const isCorrectNetwork = () => window.ethereum.networkVersion === desiredChain;

        const setReadyToGo = () => {
            goButton.disabled = false;
        }

        const clearReadyToGo = () => {
            goButton.disabled = true;
        }

        const reconcileConnection = () => {
            if (
                connected &&
                isCorrectNetwork()
            ) {
                setReadyToGo();
            } else {
                clearReadyToGo();
            }
        }

        const setNeedsOnboarding = () => {
            connectButton.innerText = 'Install MetaMask';
            connectButton.onclick = () => {
                onboarding.startOnboarding();
                setOnboarding();
            };
        }

        const setOnboarding = () => {
            connectButton.innerText = 'Onboarding in progress';
            connectButton.disabled = true;
        }

        const setDisconnected = () => {
            connectButton.innerText = 'Connect Wallet';
            connectButton.disabled = false;
            connectButton.onclick = async () => {
                accounts = await window.ethereum.enable();
                if (accounts && accounts.length) {
                    setConnected(accounts[0]);
                }
            };
        }

        const setConnected = (account) => {
            wallet = account;
            connected = true;
            onboarding.stopOnboarding();
            walletField.value = account;
            connectButton.onclick = null;
            connectButton.innerText = isCorrectNetwork() ? 'Wallet Connected' : 'Wrong Network';
            connectButton.disabled = isCorrectNetwork();
            reconcileConnection();
        }

        const refresh = () => {

            if (!MetaMaskOnboarding.isMetaMaskInstalled()) {

                setNeedsOnboarding();

            } else if (accounts && accounts.length > 0) {

                setConnected(accounts[0]);

            } else {

                setDisconnected();

            }

            reconcileConnection();
        };

        // Prepare environment once loaded
        window.addEventListener('DOMContentLoaded', () => {

            // Prepare MetaMask onboarding
            onboarding = new MetaMaskOnboarding();

            // Refresh UI when network changes
            window.ethereum.on('chainChanged', refresh);
            window.ethereum.on('networkChanged', refresh);

            // Get handles to DOM elements
            connectButton = document.getElementById('connect');
            walletField = document.getElementById('wallet');
            stateField = document.getElementById('state');
            goButton = document.getElementById('go');

            refresh();

        });

    </script>

    <!-- Header & Navigation -->
    <div class="container">
        <header class="d-flex flex-wrap justify-content-center py-3 mb-4">
            <a href="https://github.com/cliffhall/Fismology" class="d-flex align-items-center mb-3 mb-md-0 me-md-auto text-dark text-decoration-none">
                <svg class="bi me-2" width="40" height="32"><use xlink:href="#logo"/></svg>
                <span class="fs-4"><img src="images/Fismology.png" height="50"></span>
            </a>

            <ul class="nav nav-pills">
                <li class="nav-item"><a href="#diagram" class="nav-link link">Diagram</a></li>
                <li class="nav-item"><a href="#need-a-wallet" class="nav-link link">Need a Wallet?</a></li>
                <li class="nav-item">
                    <button id="connect" type="button" disabled class="btn darkBg">Loading...</button>
                </li>
            </ul>
        </header>
    </div>

    <!-- Content -->
    <div class="container col-xxl-8 px-4 py-5">

        <!-- Form and Machine -->
        <div class="row flex-lg-row-reverse align-items-top g-5 py-5">

            <!-- Form -->
            <div class="col-lg-6">
                <h1 class="display-5 fw-bold lh-1 mb-3">Lockable Door Machine</h1>
                <b>Interact with a Fismo Machine installed on a public blockchain.</b>
                <p>
                <ul class="bi bi-card-checklist">
                <li>Connect your wallet to the <b>Polygon Mumbai Testnet</b> network.</li>
                <li>Your current state in the machine will be shown.</li>
                <li>Choose an action and click <b>Let's Go!</b></li>
                <li>View the cloned <a href="https://mumbai.polygonscan.com/address/0x3d3618dD34c77c56D09F57F2Cb98eE0AA0719B4b" target="_blank" rel="noopener noreferrer nofollow" class="link">Fismo</a> contract on PolygonScan.</li>
                <li>View the <a href="https://mumbai.polygonscan.com/address/0x3f0D8faCb355001e15614d185DFf18ACC43a20ea#code" target="_blank" rel="noopener noreferrer nofollow" class="link">LockableDoorGuards</a> contract on PolygonScan.</li>
                </ul>
                </p>
                <form action="" method="post" class="d-grid gap-2 d-md-flex justify-content-md-start">
                    <div class="col-lg">
                        <div class="input-group mb-3">
                            <div class="input-group-text lightBg">Wallet&nbsp;</div>
                            <input type="text" id="wallet" name="wallet" disabled class="form-control address"/>
                        </div>
                        <div class="input-group mb-3">
                            <div class="input-group-text lightBg">State&nbsp;&nbsp;</div>
                            <input type="text" id="state" name="state" disabled class="form-control"/>
                        </div>
                        <div class="input-group mb-3">
                            <div class="input-group-text darkBg">Action</div>
                            <select class="form-select" id="action" data-placeholder="Action">
                                <option></option>
                                <option>Open</option>
                                <option>Close</option>
                                <option>Lock</option>
                                <option>Unlock</option>
                            </select>
                        </div>
                        <div class="d-flex flex-wrap justify-content-end">
                            <button id="go" type="submit" disabled class="btn darkBg">Let's Go!</button>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Machine -->
            <div class="col-10 col-sm-8 col-lg-6">

                <!-- Overlay -->
                <div class="visual">
                    <img class="machine" src="images/machine.png"/>
                    <img id="state-Locked" name="state-Locked" class="overlay hide" src="images/LockableDoor/Locked.png" width="100%"/>
                    <img id="state-Unlocked" name="state-Unlocked" class="overlay hide" src="images/LockableDoor/Unlocked.png" width="100%"/>
                    <img id="state-Opened" name="state-Opened" class="overlay hide" src="images/LockableDoor/Opened.png" width="100%"/>
                </div>
            </div>

        </div>

        <!-- State Machine Diagram -->
        <div class="container px-4 py-5" id="diagram">
            <img src="images/LockableDoorFSM.png" width="100%"/>
        </div>

        <!-- Wallet Info -->
        <div class="container px-4 py-5" id="need-a-wallet">

            <h1 class="display-4 fw-bold text-center">Need a Funded Wallet?</h1>

            <div class="row g-4 py-5 row-cols-1 row-cols-lg-2">
                <div class="feature col justify">
                    <h2>1. Install MetaMask</h2>
                    <p>MetaMask is a web extension, which allows you to manage your blockchain assets via your web browser.</p>
                    <p>If you don't have MetaMask installed you will see a button on the form above that says <b>"Install Metamask"</b>. Click it and follow all instructions.</p>
                    <p>Once your MetaMask wallet is installed you will be returned to this page, and the button will have changed to say <b>"Connect Wallet"</b>.</p>
                </div>
                <div class="feature col">
                    <h2>2. Configure</h2>
                    <p>Configure MetaMask for the <b>Polygon Mumbai Testnet</b> network.</p>
                    <p>In order to view the assets in your account on the <b>Polygon Mumbai Testnet</b> network, you may need to configure Maticâ€™s URL on Metamask.</p>
                </div>
                <div class="feature col">
                    <h2>3. Connect</h2>
                    <p>On the form above, click the button that says <b>"Connect Wallet"</b>.</p>
                    <p>MetaMask will open a window to ask if you'd like to connect to this site. Click <b>"Connect"</b>.</p>
                    <p>The <b>"Connect Wallet"</b> button above will be replaced with the phrase <b>"Wallet Connected"</b>.</p>
                    <p>If you see the phrase <b>"Wrong Network"</b>, click the MetaMask icon on your browser and choose the <b>Polygon Mumbai Testnet</b> network from the dropdown at the top.</p>
                </div>
                <div class="feature col">
                    <h2>4. Get $MATIC</h2>
                    <p>You can get free  <b>Polygon Mumbai $MATIC</b> at the
                        <a href="https://faucet.polygon.technology/" target="_blank" rel="noopener noreferrer nofollow" class="link">Polygon Faucet</a>
                    </p>
                </div>
            </div>
        </div>

    </div>

    </main>

    <!-- Footer -->
    <nav class="navbar fixed-bottom navbar-light pageBg">
        <div class="container justify-content-center">
            <a class="navbar-brand" href="https://futurescale.com" target="_blank" rel="noopener noreferrer nofollow">
                <img src="images/created-by.png" height="38">
            </a>
        </div>
    </nav>
</body>
</html>
